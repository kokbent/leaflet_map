---
title: "Oyster Restoration Project Plotting"
author: "Mel Moreno"
date: "January 25, 2018"
output:
  html_document:
    toc: true
    toc_float: true
---

##Introduction

The following tutorial will is to assist the user to import and plot data from Diver and Star Oddi sensors from flat files, aka .csv. When the database is built, the script will change to allow for data importing from MySQL. At that time there will be less code needed for column and date formatting. At this time the script is specifically for flat file from files directly imported from the Diver and SeaStar software. 

```{r total_packages, include=FALSE}
library(cowplot)
library(devtools)
library(ggplot2)
library(grid)
library(gridExtra)
library(lattice)
library(marelac)
library(scales)
library(zoo)
library(knitr)
library(rmarkdown)

```
##Downloading developer `ggplot2`

We are using developer 'ggplot2' to use newer features in `ggplot`. Download `ggplot2` in the following way through Hadley. Plotting could also be done with base `ggplot2`, but there are some instances where we can add additional plotting features using the developer `ggplot2`. Currently, this script is configured to plot with developer `ggplot2`. 

```{r ggplotpackage, eval=FALSE, include= TRUE}
install.packages ("devtools")
library(devtools)
dev_mode(on=T)
install_github("hadley/ggplot2")
dev_mode(on=F)

install.packages("colorspace")
devtools::install_github("tidyverse/ggplot2",dep = TRUE)
```

##Retrieving data

The code below is to import data from flat files, aka csv. files, and etc. More code will be written/changed to retrieve the data from a working MYSQL database. Change the script to your working directory. Allow for `header=TRUE`, which informs R that the first row are column headings.

```{r importdata, include=FALSE, eval=TRUE}

setwd("C:/Users/melimore86/Desktop/Deployment/Lone Cabbage WQ Data/LC_WQ1/CSV")
LC_WQ1 <- read.csv("LC_WQ1_All_Days_R.csv", header= T)

setwd("C:/Users/melimore86/Desktop/Deployment/Lone Cabbage WQ Data/LC_WQ2/CSV")
LC_WQ2 <- read.csv("LC_WQ2_All_Days_R.csv", header= T)

setwd("C:/Users/melimore86/Desktop/Deployment/Lone Cabbage WQ Data/LC_WQ3/CSV")
LC_WQ3 <- read.csv("LC_WQ3_All_Days_R.csv", header= T)

setwd("C:/Users/melimore86/Desktop/Deployment/Lone Cabbage WQ Data/LC_WQ4/CSV")
LC_WQ4 <- read.csv("LC_WQ4_All_Days_R.csv", header= T)

setwd("C:/Users/melimore86/Desktop/Deployment/Lone Cabbage WQ Data/LC_WQ5/CSV")
LC_WQ5 <- read.csv("LC_WQ5_All_Days_R.csv", header= T)

setwd("C:/Users/melimore86/Desktop/Deployment/Lone Cabbage WQ Data/LC_WQ6/CSV")
LC_WQ6 <- read.csv("LC_WQ6_All_Days_R.csv", header= T)

setwd("C:/Users/melimore86/Desktop/Deployment/Lone Cabbage WQ Data/LC_WQ7/CSV")
LC_WQ7 <- read.csv("LC_WQ7_All_Days_R.csv", header= T)

setwd("C:/Users/melimore86/Desktop/Deployment/Lone Cabbage WQ Data/LC_WQ8/CSV")
LC_WQ8 <- read.csv("LC_WQ8_All_Days_R.csv", header= T)

setwd("C:/Users/melimore86/Desktop/Deployment/Lone Cabbage WQ Data/LC_WQ9/CSV")
LC_WQ9 <- read.csv("LC_WQ9_All_Days_R.csv", header= T)
```

The next script will be to import the data from our flat files into the R Studio environment.

```{r importdata2, include=TRUE, eval=FALSE}

setwd("C:/Users/yourdirectory/Desktop/Deployment/Lone Cabbage WQ Data/LC_WQ/CSV")
LC_WQ1 <- read.csv("LC_WQ1_All_Days_R.csv", header= T)
LC_WQ2 <- read.csv("LC_WQ2_All_Days_R.csv", header= T)
LC_WQ3 <- read.csv("LC_WQ3_All_Days_R.csv", header= T)
LC_WQ4 <- read.csv("LC_WQ4_All_Days_R.csv", header= T)
LC_WQ5 <- read.csv("LC_WQ5_All_Days_R.csv", header= T)
LC_WQ6 <- read.csv("LC_WQ6_All_Days_R.csv", header= T)
LC_WQ7 <- read.csv("LC_WQ7_All_Days_R.csv", header= T)
LC_WQ8 <- read.csv("LC_WQ8_All_Days_R.csv", header= T)
LC_WQ9 <- read.csv("LC_WQ9_All_Days_R.csv", header= T)
```



##Renaming Columns

Diver and Star Oddi flat sensors have slightly different measurements they collect. The script is separated by which sensor headings are being changed/updated. In this case for Sites 1 and 3, we will use a different code that will allow for renaming columns correctly for Diver .csv files.

```{r columns_1and3}
#Naming columns, using the Diver sensors, collects date, pressure, temp, conductivity
colnames(LC_WQ1) <- c("DateTime_Serial", "Pressure", "Temperature", "Conductivity")
colnames(LC_WQ3) <- c("DateTime_Serial", "Pressure", "Temperature", "Conductivity")

```

Below is the script to change column headings for the Star Oddi flat files that are exported directly from the SeaStar Software. This script is for renaming columns for easier coding and understanding of the data. 

```{r renamecolumns}
#Renaming columns 
colnames(LC_WQ2) <- c("DateTime_Serial", "Temperature", "Salinity", "Conductivity", "Sound/Velocity")
colnames(LC_WQ4) <- c("DateTime_Serial", "Temperature", "Salinity", "Conductivity", "Sound/Velocity")
colnames(LC_WQ5) <- c("DateTime_Serial", "Temperature", "Salinity", "Conductivity", "Sound/Velocity")
colnames(LC_WQ6) <- c("DateTime_Serial", "Temperature", "Salinity", "Conductivity", "Sound/Velocity")
colnames(LC_WQ7) <- c("DateTime_Serial", "Temperature", "Salinity", "Conductivity", "Sound/Velocity")
colnames(LC_WQ8) <- c("DateTime_Serial", "Temperature", "Salinity", "Conductivity", "Sound/Velocity")
colnames(LC_WQ9) <- c("DateTime_Serial", "Temperature", "Salinity", "Conductivity", "Sound/Velocity")

```

##Changing date/timestamp using `zoo`

To change dates and times in a suitable format to plot with base R, we are using the package `zoo` to convert the date timestamp into a `zoo` object. For `ggplot` the date/timestamp will be to be converted into an `as.POSIXct` `as.Date`. When you add the file name with a `$` and a new column heading, R will create a new column to the data.

```{r datechange, warning= FALSE, message=FALSE, results="hide", eval=TRUE}

#Changing the format of the dates to be able to plot against time
LC_WQ1$newDate <- as.POSIXct(as.Date(LC_WQ1$DateTime_Serial,origin= "1899-12-30"))
LC_WQ2$newDate <- as.POSIXct(as.Date(LC_WQ2$DateTime_Serial,origin= "1899-12-30"))
LC_WQ3$newDate <- as.POSIXct(as.Date(LC_WQ3$DateTime_Serial,origin= "1899-12-30"))
LC_WQ4$newDate <- as.POSIXct(as.Date(LC_WQ4$DateTime_Serial,origin= "1899-12-30"))
LC_WQ5$newDate <- as.POSIXct(as.Date(LC_WQ5$DateTime_Serial,origin= "1899-12-30"))
LC_WQ6$newDate <- as.POSIXct(as.Date(LC_WQ6$DateTime_Serial,origin= "1899-12-30"))
LC_WQ7$newDate <- as.POSIXct(as.Date(LC_WQ7$DateTime_Serial,origin= "1899-12-30"))
LC_WQ8$newDate <- as.POSIXct(as.Date(LC_WQ8$DateTime_Serial,origin= "1899-12-30"))
LC_WQ9$newDate <- as.POSIXct(as.Date(LC_WQ9$DateTime_Serial,origin= "1899-12-30"))

```
The current plots created with `ggplot` do not require that the date/timestamp be converted into a `zoo` object, but if you would like to plots with base R, then this step is needed. An exmaple of a plot will be provided, using base R.

```{r zoo, warning= FALSE, message=FALSE, results="hide", eval=TRUE}
library(zoo)

LC_WQ1_zoo <- zoo(LC_WQ1[, 2:5],order.by= LC_WQ1$newDate)
LC_WQ2_zoo <- zoo(LC_WQ2[, 2:5],order.by= LC_WQ2$newDate)
LC_WQ3_zoo <- zoo(LC_WQ3[, 2:5],order.by= LC_WQ3$newDate)
LC_WQ4_zoo <- zoo(LC_WQ4[, 2:5],order.by= LC_WQ4$newDate)
LC_WQ5_zoo <- zoo(LC_WQ5[, 2:5],order.by= LC_WQ5$newDate)
LC_WQ6_zoo <- zoo(LC_WQ6[, 2:5],order.by= LC_WQ6$newDate)
LC_WQ7_zoo <- zoo(LC_WQ7[, 2:5],order.by= LC_WQ7$newDate)
LC_WQ8_zoo <- zoo(LC_WQ8[, 2:5],order.by= LC_WQ8$newDate)
LC_WQ9_zoo <- zoo(LC_WQ9[, 2:5],order.by= LC_WQ9$newDate)

```
Here is an example of a base R plot that can be created using `zoo` for the date/timestamp.

```{r basicrplots, warning= FALSE, message=FALSE, eval=TRUE}
plot(LC_WQ4_zoo$Salinity, ylab="Salinity (ppt)", lwd= 2, xlab= "Date", ylim= c(0, 40), main= "Site 4 Salinity")
```




##Calculating Salinity with Conductivity and Temperature 

To calculate salinity, we are using the package `marelac`. The conductivity and temperature is used also with the standard. Currently, Star Oddi sensors do not measure salinity, but Diver sensors do. We are still converting the salinity using the equation below for the Diver sensors, to keep consistency.

```{r salcal, warning= FALSE,  message=FALSE, results="hide"}

library(marelac)

standard= 42.914

LC_WQ1$Salinity <- convert_RtoS(LC_WQ1$Conductivity/standard, 
                                t= LC_WQ1$Temperature, p= 0)
LC_WQ2$Salinity <- convert_RtoS(LC_WQ2$Conductivity/standard, 
                                t= LC_WQ2$Temperature, p=0)
LC_WQ3$Salinity <- convert_RtoS(LC_WQ3$Conductivity/standard, 
                                t= LC_WQ3$Temperature, p= 0)
LC_WQ4$Salinity <- convert_RtoS(LC_WQ4$Conductivity/standard, 
                                t= LC_WQ4$Temperature, p=0)
LC_WQ5$Salinity <- convert_RtoS(LC_WQ5$Conductivity/standard, 
                                t= LC_WQ5$Temperature, p=0)
LC_WQ6$Salinity <- convert_RtoS(LC_WQ6$Conductivity/standard, 
                                t= LC_WQ6$Temperature, p=0)
LC_WQ7$Salinity <- convert_RtoS(LC_WQ7$Conductivity/standard, 
                                t= LC_WQ7$Temperature, p=0)
LC_WQ8$Salinity <- convert_RtoS(LC_WQ8$Conductivity/standard, 
                                t= LC_WQ8$Temperature, p=0)
LC_WQ9$Salinity <- convert_RtoS(LC_WQ9$Conductivity/standard, 
                                t= LC_WQ9$Temperature, p=0)

```


##River Discharge data
The plots will require river discharge data, which will be retrieved the `waterData` and `hydroTSM` packages. The station closest to the Lone Cabbage sensors in Cedar Key is '02323500'. Sometimes all of the river discharge data is not available, and some gaps will be present. Run the script the following week, to see if the data has been added to the package. This should close up any gaps in the continuous river discharge data.


```{r riverdisharge, warning= FALSE,  message=FALSE, results="hide" }
library(waterData)
library(hydroTSM)

#Station to analyze, can be changed to another station
station = '02323500'   

#Get site name to use in plot titles and such
stinfo  = siteInfo(station)

#Read entire time series, might take several minutes
dis   = importDVs(staid=station,code='00060',stat='00003', sdate= "1950-01-01") 

#Getting some date components
dis$year    = as.numeric(strftime(dis$dates,format="%Y"))
dis$month   = as.numeric(strftime(dis$dates,format="%m")) 

#Making dataset from epochs, 
disE  = dis[dis$dates>='1950-01-01' & dis$dates<='2017-10-01',]  

#Getting monthly sum, mean, sd, and var
#discharge
disE.mo  = aggregate(val~month+year,data=disE,FUN = function(x) c(mean(x,na.rm=T),sd(x,na.rm=T),var(x,na.rm=T),sum(x)))
disE.mo  = do.call('data.frame',disE.mo)
names(disE.mo)[3:6] = c('avg','sd','var','sumflow') 
disE.mo$yrmo = disE.mo$year+(disE.mo$month-0.5)/12       


#Getting yearly mean, sd, and var
#discharge
disE.yr  = aggregate(val~year,data=disE,FUN = function(x) c(mean(x,na.rm=T),sd(x,na.rm=T),var(x,na.rm=T)))
disE.yr  = do.call('data.frame',disE.yr)
names(disE.yr)[2:4] = c('avg','sd','var')                      


#Making some time series objects with `zoo` for base R plotting
disE.zoo    = zoo(disE$val,disE$dates)  

disE.mo.ts  = ts(disE.mo$avg,start=c(1950,1),end=c(2017,10),frequency=12)
disE.mo.sum.ts  = ts(disE.mo$sumflow,start=c(1950,1),end=c(2017,10),frequency=12)
disE.yr.ts  = ts(disE.yr$avg,start=1950,end=2017,frequency=1)
```

##River Dischage date/timestamp

The river discharge data will also need to have the same date/timestamp format to plot well with the salinity and temperature data.

```{r rddate, warning= FALSE,  message=FALSE, results="hide"}

#Naming columns, using the Diver sensors, collects date, pressure, temp, conductivity
colnames(dis) <- c("StaID", "Values", "Date", "QualCode", "Year", "Month")
head(dis)

#Changing the format of the dates to be able to plot against time
dis$newDate <- as.POSIXct(as.Date(dis$Date,origin= "1899-12-30"))

#Using `zoo` to add the date to the column
dis_zoo <- zoo(dis[, 2:5],order.by= dis$newDate)
```

As mentioned before, the `zoo` date/timestamp can be used for base R plots, but the conversion is not needed for `ggplot` plots. Here is an example of plotting river discharge with `zoo` date/timestamp. 

```{r rdzooplot, warning= FALSE, message=FALSE, eval=TRUE}
plot(dis_zoo$Values, ylab="River Discharge", lwd= 2, xlab= "Date", ylim= c(0, 55000), main= "River Discharge", col="blue")
```


##Plotting

Using `ggplot2` for plotting, is a dynamic and efficient tool. Script can be easily changed and manipulated to give you your desired visual aesthetics. In addition to being easy to read, `ggplot` graphs can have multiple variables plotted, just by adding another variable with a `+`. The developer package is constantly being updated, so more customization might be available in the future.


##Creating plots for each site

Each site will require its own plot to be created with the variables of salinity, temperature, and river discharge. The script lines will be explained in `Var1`, but will not be for the rest of the sites, since the script is almost virtually the same. Each new line is added with a `+` and each new addition is added to the plot, which means that the order in which each added elements is applied can change the way the plot looks. In this case, if the river temperature points are added after salinity points, temperature will appear above salinity. But these plots are focusing more on salinity, so salinity should overlay all other variables. 

```{r allplots, warning= FALSE,  message=FALSE,}
library(ggplot2)
library(grid)
library(gridExtra)
library(lattice)
library(scales)

Var1 <- #saving the plot under a name, in this case it is "Var1"
  ggplot(data= LC_WQ1, aes(x= newDate)) + #add the data file name, and describe the aesthetics using aes(x=, y=), we specify the y-axis in later script
  ggtitle("Site 1") + #creating a title for the plot
  labs(x= "Date", y= "Temp(C) & Salinity (ppt)") + #changing the labels for the x and y- axis
  geom_ribbon(data= dis, aes(x= newDate, y=Values/500, ymin=0, ymax=Values/500, fill= "blue"), fill= "cornflowerblue", alpha=0.5) + #the ribbon creates a shadow area for the river discharge, and the y values are a fraction of the actual data, which will be corrected when we add our secondary axis
  geom_point(aes(y= Temperature, colour= "Temperature"), color= "red", size= .9) + #plotting points for the y-axis of Temperature
  geom_point(aes(y= Salinity, colour= "Salinity"), color= "#000000") + #plotting points for the y-axis of Salinity
  scale_y_continuous(sec.axis = sec_axis(~.*500, name = "River Discharge"), limits=c(0,40)) + #creating a secondary y-axis for the river discharge that is portional to the fraction of the river discharge we calculated before
  scale_x_datetime(
    breaks = date_breaks("week") ,
    labels = date_format("%m/%d"),
    expand = c(0, 0),
    limits = c(
      as.POSIXct("2017-08-10"),
      as.POSIXct("2018-01-12"))) + #the end date will need to be changed for every new sensor servicing, the dates are in YYYY-MM-DD, the date breaks are by 'week' but can be monthly or daily
  theme(panel.border = element_rect(color = "black", size = 0.5, fill = NA, linetype="solid"),
        axis.text=element_text(size=15),
        axis.title=element_text(size=15,face="bold"),
        plot.title =element_text(size=20, face='bold'),
        axis.text.x = element_text(angle = 90, hjust = 1),
        aspect.ratio = 0.70) #the theme is specifically formatted to be saved as a large .tiff image, this can be edited to a different size graph

Var2 <-
  ggplot(data= LC_WQ2, aes(x= newDate)) +
  ggtitle("Site 2") +
  labs(x= "Date", y= "Temp(C) & Salinity (ppt)") +
  geom_ribbon(data= dis, aes(x= newDate, y=Values/500, ymin=0, ymax=Values/500, fill= "blue"), fill= "cornflowerblue", alpha=0.5) +
  geom_point(aes(y= Temperature, colour= "Temperature"), color= "red", size= .9) +
  geom_point(aes(y= Salinity, colour= "Salinity"), color= "#000000") +
  scale_y_continuous(sec.axis = sec_axis(~.*500, name = "River Discharge"), limits=c(0,40)) +
  scale_x_datetime(
    breaks = date_breaks("week") ,
    labels = date_format("%m/%d"),
    expand = c(0, 0),
    limits = c(
      as.POSIXct("2017-08-10"),
      as.POSIXct("2018-01-12"))) +
theme(panel.border = element_rect(color = "black", size = 0.5, fill = NA, linetype="solid"),
        axis.text=element_text(size=15),
        axis.title=element_text(size=15,face="bold"),
        plot.title =element_text(size=20, face='bold'),
        axis.text.x = element_text(angle = 90, hjust = 1),
        aspect.ratio = 0.70)

Var3 <-
  ggplot(data= LC_WQ3, aes(x= newDate)) +
  ggtitle("Site 3") +
  labs(x= "Date", y= "Temp(C) & Salinity (ppt)") +
  geom_ribbon(data= dis, aes(x= newDate, y=Values/500, ymin=0, ymax=Values/500, fill= "blue"), fill= "cornflowerblue", alpha=0.5) +
  geom_point(aes(y= Temperature, colour= "Temperature"), color= "red", size= .9) +
  geom_point(aes(y= Salinity, colour= "Salinity"), color= "#000000") +
  scale_y_continuous(sec.axis = sec_axis(~.*500, name = "River Discharge"), limits=c(0,40)) +
  scale_x_datetime(
    breaks = date_breaks("week") ,
    labels = date_format("%m/%d"),
    expand = c(0, 0),
    limits = c(
      as.POSIXct("2017-08-10"),
      as.POSIXct("2018-01-12"))) +
  theme(panel.border = element_rect(color = "black", size = 0.5, fill = NA, linetype="solid"),
        axis.text=element_text(size=15),
        axis.title=element_text(size=15,face="bold"),
        plot.title =element_text(size=20, face='bold'),
        axis.text.x = element_text(angle = 90, hjust = 1),
        aspect.ratio = 0.70)

Var4 <-
  ggplot(data= LC_WQ4, aes(x= newDate)) +
  ggtitle("Site 4") +
  labs(x= "Date", y= "Temp(C) & Salinity (ppt)") +
  geom_ribbon(data= dis, aes(x= newDate, y=Values/500, ymin=0, ymax=Values/500, fill= "blue"), fill= "cornflowerblue", alpha=0.5) +
  geom_point(aes(y= Temperature, colour= "Temperature"), color= "red", size= .9) +
  geom_point(aes(y= Salinity, colour= "Salinity"), color= "#000000") +
  scale_y_continuous(sec.axis = sec_axis(~.*500, name = "River Discharge"), limits=c(0,40)) +
  scale_x_datetime(
    breaks = date_breaks("week") ,
    labels = date_format("%m/%d"),
    expand = c(0, 0),
    limits = c(
      as.POSIXct("2017-08-10"),
      as.POSIXct("2018-01-12"))) +
  theme(panel.border = element_rect(color = "black", size = 0.5, fill = NA, linetype="solid"),
        axis.text=element_text(size=15),
        axis.title=element_text(size=15,face="bold"),
        plot.title =element_text(size=20, face='bold'),
        axis.text.x = element_text(angle = 90, hjust = 1),
        aspect.ratio = 0.70)

Var5 <-
  ggplot(data= LC_WQ5, aes(x= newDate)) +
  ggtitle("Site 5") +
  labs(x= "Date", y= "Temp(C) & Salinity (ppt)") +
  geom_ribbon(data= dis, aes(x= newDate, y=Values/500, ymin=0, ymax=Values/500, fill= "blue"), fill= "cornflowerblue", alpha=0.5) +
  geom_point(aes(y= Temperature, colour= "Temperature"), color= "red", size= .9) +
  geom_point(aes(y= Salinity, colour= "Salinity"), color= "#000000") +
  scale_y_continuous(sec.axis = sec_axis(~.*500, name = "River Discharge"), limits=c(0,40)) +
  scale_x_datetime(
    breaks = date_breaks("week") ,
    labels = date_format("%m/%d"),
    expand = c(0, 0),
    limits = c(
      as.POSIXct("2017-08-10"),
      as.POSIXct("2018-01-12"))) +
  theme(panel.border = element_rect(color = "black", size = 0.5, fill = NA, linetype="solid"),
        axis.text=element_text(size=15),
        axis.title=element_text(size=15,face="bold"),
        plot.title =element_text(size=20, face='bold'),
        axis.text.x = element_text(angle = 90, hjust = 1),
        aspect.ratio = 0.70)

Var6 <-
  ggplot(data= LC_WQ6, aes(x= newDate)) +
  ggtitle("Site 6") +
  labs(x= "Date", y= "Temp(C) & Salinity (ppt)") +
  geom_ribbon(data= dis, aes(x= newDate, y=Values/500, ymin=0, ymax=Values/500, fill= "blue"), fill= "cornflowerblue", alpha=0.5) +
  geom_point(aes(y= Temperature, colour= "Temperature"), color= "red", size= .9) +
  geom_point(aes(y= Salinity, colour= "Salinity"), color= "#000000") +
  scale_y_continuous(sec.axis = sec_axis(~.*500, name = "River Discharge"), limits=c(0,40)) +
  scale_x_datetime(
    breaks = date_breaks("week") ,
    labels = date_format("%m/%d"),
    expand = c(0, 0),
    limits = c(
      as.POSIXct("2017-08-10"),
      as.POSIXct("2018-01-12"))) +
  theme(panel.border = element_rect(color = "black", size = 0.5, fill = NA, linetype="solid"),
        axis.text=element_text(size=15),
        axis.title=element_text(size=15,face="bold"),
        plot.title =element_text(size=20, face='bold'),
        axis.text.x = element_text(angle = 90, hjust = 1),
        aspect.ratio = 0.70)

Var7 <-
  ggplot(data= LC_WQ7, aes(x= newDate)) +
  ggtitle("Site 7") +
  labs(x= "Date", y= "Temp(C) & Salinity (ppt)") +
  geom_ribbon(data= dis, aes(x= newDate, y=Values/500, ymin=0, ymax=Values/500, fill= "blue"), fill= "cornflowerblue", alpha=0.5) +
  geom_point(aes(y= Temperature, colour= "Temperature"), color= "red", size= .9) +
  geom_point(aes(y= Salinity, colour= "Salinity"), color= "#000000") +
  scale_y_continuous(sec.axis = sec_axis(~.*500, name = "River Discharge"), limits=c(0,40)) +
  scale_x_datetime(
    breaks = date_breaks("week") ,
    labels = date_format("%m/%d"),
    expand = c(0, 0),
    limits = c(
      as.POSIXct("2017-08-10"),
      as.POSIXct("2018-01-12"))) +
  theme(panel.border = element_rect(color = "black", size = 0.5, fill = NA, linetype="solid"),
        axis.text=element_text(size=15),
        axis.title=element_text(size=15,face="bold"),
        plot.title =element_text(size=20, face='bold'),
        axis.text.x = element_text(angle = 90, hjust = 1),
        aspect.ratio = 0.70)

Var8 <-
  ggplot(data= LC_WQ8, aes(x= newDate)) +
  ggtitle("Site 8") +
  labs(x= "Date", y= "Temp(C) & Salinity (ppt)") +
  geom_ribbon(data= dis, aes(x= newDate, y=Values/500, ymin=0, ymax=Values/500, fill= "blue"), fill= "cornflowerblue", alpha=0.5) +
  geom_point(aes(y= Temperature, colour= "Temperature"), color= "red", size= .9) +
  geom_point(aes(y= Salinity, colour= "Salinity"), color= "#000000") +
  scale_y_continuous(sec.axis = sec_axis(~.*500, name = "River Discharge"), limits=c(0,40)) +
  scale_x_datetime(
    breaks = date_breaks("week") ,
    labels = date_format("%m/%d"),
    expand = c(0, 0),
    limits = c(
      as.POSIXct("2017-08-10"),
      as.POSIXct("2018-01-12"))) +
  theme(panel.border = element_rect(color = "black", size = 0.5, fill = NA, linetype="solid"),
        axis.text=element_text(size=15),
        axis.title=element_text(size=15,face="bold"),
        plot.title =element_text(size=20, face='bold'),
        axis.text.x = element_text(angle = 90, hjust = 1),
        aspect.ratio = 0.70)

Var9 <-
  ggplot(data= LC_WQ9, aes(x= newDate)) +
  ggtitle("Site 9") +
  labs(x= "Date", y= "Temp(C) & Salinity (ppt)") +
  geom_ribbon(data= dis, aes(x= newDate, y=Values/500, ymin=0, ymax=Values/500, fill= "blue"), fill= "cornflowerblue", alpha=0.5) +
  geom_point(aes(y= Temperature, colour= "Temperature"), color= "red", size= .9) +
  geom_point(aes(y= Salinity, colour= "Salinity"), color= "#000000") +
  scale_y_continuous(sec.axis = sec_axis(~.*500, name = "River Discharge"), limits=c(0,40)) +
  scale_x_datetime(
    breaks = date_breaks("week") ,
    labels = date_format("%m/%d"),
    expand = c(0, 0),
    limits = c(
      as.POSIXct("2017-08-10"),
      as.POSIXct("2018-01-12"))) +
  theme(panel.border = element_rect(color = "black", size = 0.5, fill = NA, linetype="solid"),
        axis.text=element_text(size=15),
        axis.title=element_text(size=15,face="bold"),
        plot.title =element_text(size=20, face='bold'),
        axis.text.x = element_text(angle = 90, hjust = 1),
        aspect.ratio = 0.70)

```

##Grobbing a common legend using `get_legend` in `cowplot`

Since we are making plots with a common legend, we will be grobbing a graphical object from a false plot. The `legend` plot will not be used for its final product, but only for its legend. The reason another plot was created for its legend, was so specify sizes and shapes that will not change one of the already created `Var(x)` plots. Once the legend is created, an argument `get_legend` is used to extract the legend from the plot. 

```{r legendplot, warning= FALSE,  message=FALSE}

#Creating a "false" plot with a correct legend

library(cowplot)

legend <- 
  ggplot(data= LC_WQ1,aes(x= newDate)) +
  geom_point(aes(y= Salinity, fill= "Salinity   "), color= "#999999") +
  geom_point(aes(y= Temperature, fill= "Temperature   "), color= "#000000") +
  geom_point(data= dis, aes(x= newDate, y=Values/1000, fill= "River Discharge   "), color="cornflowerblue", size=2, show.legend = TRUE, pch=15, alpha=0.4) +
  guides(fill= guide_legend(show= TRUE, title="", override.aes= list(colour= c("cornflowerblue", "#000000", "red"), size=10))) +
  scale_y_continuous(sec.axis = sec_axis(~.*600, name = "River Discharge"), limits=c(0,40)) +
  theme(legend.position = "bottom", legend.text=element_text(size=30))

#creating a legend, to "grob" later in the final `ggdraw`
legend_b <- get_legend(legend + theme(legend.position="bottom"))
```

##Using `ggdraw` to arrange plots 

The package `ggdraw` allows for `ggplot` plots to be arranged in a window pane. Normally with base R, you can use `mfrow=c(nrows, ncols)` and `mfcol=c(nrows, ncols)`, but these arguments will not work with `ggplot2` plots. They also don't allow for as much customization as `ggdraw` can allow. In `ggdraw`, once the plot is specified, you can arrange the plot on an x and y-axis from 0 to 1, starting from the bottom left corner of a window. That corner is essentially 0,0. The width and the height can be adjusted in their desired size up to 1. Every plot is added with a `+`. At the end of the plots, the legend we previously created is now grobbed. The `draw_grob` is under the `cowplot` package, and is used to bring in a graphical object. In our case, the object is a legend.

```{r ggdrawplot, warning= FALSE,  message=FALSE}

library(cowplot)

varall<-
  ggdraw() +
  draw_plot(Var3, x=0.34, y=0, width=0.3, height=0.30 ) +
  draw_plot(Var2, x=0.34, y=0.30, width=0.3, height=0.30 ) +
  draw_plot(Var1, x=0.34, y=0.60, width=0.3, height=0.30 ) +
  draw_plot(Var4, x=0, y=0, width=0.3, height=0.30 ) +
  draw_plot(Var5, x=0, y=0.3, width=0.3, height=0.30 ) +
  draw_plot(Var6, x=0, y=0.6, width=0.3, height=0.30 ) +
  draw_plot(Var9, x=0.67, y=0, width=0.3, height=0.30 ) +
  draw_plot(Var8, x=0.67, y=0.3, width=0.3, height=0.30 ) +
  draw_plot(Var7, x=0.67, y=0.6, width=0.3, height=0.30 ) +
  draw_grob(legend_b, 0.9/2.5, 0.7, 2/7, 0.4, scale=0.5) 


```

```{r ggsave, eval= FALSE, warning= FALSE,  message=FALSE}

setwd("C:/Users/yourdirectory/Desktop/Deployment/Lone Cabbage WQ Data/Comparison_graphs")
ggsave("varall.tiff", units="in", width=25, height=25, dpi=300, compression = 'lzw')

```

The final plot is created using `ggdraw`. This plot is enlarged for greater detail of the data. Running the script `varall` might show a distored graph view, make sure to save it with `ggsave` in the suggested size for better results. 

```{r finalplot, echo=FALSE, fig.width=25,fig.height=25}
varall
```

##Resources and links

For more information on `ggplot2` or other packages, the cran .pdf will be listed here, as well as some other useful links.

-`ggplot2` cran
https://cran.r-project.org/web/packages/ggplot2/ggplot2.pdf


-`ggplot2` Hadley
https://github.com/hadley/ggplot2-book


-`cowplot` cran
https://cran.r-project.org/web/packages/cowplot/cowplot.pdf


-`marelac` cran
https://cran.r-project.org/web/packages/marelac/marelac.pdf

-Oyster Project Restoration Site
http://www.wec.ufl.edu/oysterproject/restoration.php


-Site where plots are used
http://rpubs.com/melimore86/sitesmap


